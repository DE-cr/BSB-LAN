  name: Update Compile Time

  on: [push, pull_request]

  jobs:
    update-compiletime:
      runs-on: ubuntu-latest

      steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Get current commit timestamp
          run: |
            TIMESTAMP=$(git show -s --format=%cd --date=format:'%Y%m%d%H%M%S' HEAD)
            PATCH_NUMBER=$(grep '#define PATCH' BSB_LAN/bsb-version.h | cut -d '"' -f 2)
            NEW_PATCH_NUMBER=$((PATCH_NUMBER + 1))

            sed -i "s/#define PATCH \".*\"/#define PATCH \"$NEW_PATCH_NUMBER\"/" BSB_LAN/bsb-version.h
            sed -i 's/^#define COMPILETIME .*$/#define COMPILETIME "'"$TIMESTAMP"'"/' BSB_LAN/bsb-version.h

        - name: Cleanup workspace
          run: |
            sudo rm -rf * .[!.]* ..?*  # Dangerous: Removes all files in the current directory safely, include hidden ones.

        - name: Reclone the repository
          run: |
            git clone https://github.com/fredlcore/BSB-LAN.git .

        - name: Setup git config
          run: |
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
  
        - name: Commit changes
          run: |
            git add BSB_LAN/bsb-version.h
            git commit --amend --no-edit   
            git fetch
            git rebase origin/master
            git push --force-with-lease origin HEAD:master